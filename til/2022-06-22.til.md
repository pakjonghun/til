---
date: 2022-06-22
category: til, aws, redux
---

## 오늘 한 일

- 초과근무 프로젝트
  - 계속 버그픽스
    - 서버접속이 안되는데 아무 메세지가 없어서 메세지를 추가함
    - cors 를 계속 수정하면서 최대한 범위를 좁힘
    - 근무기록 수정 후 바로 데이터가 최신화가 안되는 문제 해결(캐쉬 무효화)
    - rtk mutation 이 제대로 작동안되는 문제 해결(컴포넌트를 통째로 null 로 반환하는 코드가 숨어있었다니 ㅠ)
  - 배포 완료
    - ec2, rds, route53, lamda, hostzone 등 오직 aws 만 이용해서 배포
    - cookie 를 주고받는 방식이라서 각 서버간 cors 설정이 안맞아서 계속 해매다가 결국 해결함 ㅠ

## 어려운점

- redux rtk 는 정말로 swr react-query 와는 완전 다르다.
  - 로그인 여부를 파악하는 훅을 메인 페이지의 레이아웃에서 실행시켜줬다.
  - 레이아웃의 children 에서 실행되는 rtk mutation 이 있었는데 layout 컴포넌트가 없을경우(로딩중이거나, 해서 null 만 반환할 경우) 담당하는 isLoading isSuccess 같은 state 를 업데이트를 시키지 못하는 문제를 발견했다.
  - swr react-query 는 막 이 페이지 저페이지 에서 필요할때 쿼리 뮤테이션 막 날리고 했다면
  - rtk 는 정말 잘 따져보고 고민해서 query 나 mutation 위치를 정해야 한다.
  - 안그러면 아예 작동 안하는 코드가 생길 수도 있다(통신을 하긴 하는데... 잘 응답도 받는데 state 가 isSuccess 가 true 로 안되고, isLoading 가 false 로 안바뀌는 상황 ㅠ ㅠ )
- 초과근무 프로젝트가 정말로 마무리 되었다.
  - 오늘 프로젝트 배포만 금방 끝내고 알고리즘이나 풀려고 했는데 결국 밤이 다되서야 끝낼 수 있었다.
  - 왜 시간이 오래 걸렸는지 남긴다 ㅠ 앞으로 이런걸로 시간을 허비하지 말자!!
    - ec2 에서 origin 은 해당 ip 나 domain 으로 넣어줘야 한다.(localhost 이런거 작동 안한다.)
    - ec2 에서 인스턴스를 끄고 키는 경우가 많은데 자꾸 ip 가 바뀌므로 탄력적 ip 를 만들어서 달아주자!
    - ec2는 ip 가 바뀌면 느려지는 경향이 있다. 이때 자꾸 고민하면서 이것저것 하지말고 그냥 껏다 키자 바로 해결된다.
    - cookie 를 주고 받으려면 origin 이 같아야 하고 백과 프론트 서버 모두 credential 이 true 가 되야한다
    - domain 을 달아줬으면 ip 가 아닌 domain 으로 오리진을 바꿔줘야 cookie를 잘 주고 받는다
    - react 에서 webpack 를 프로덕션 모드로 빌드 하는 방법으로 배포후 빌드 했다면
      .env 가 바뀌어도 다시 빌드해야 .env 내용이 제대로 적용된다.
  - 도메인을 매칭시켜줬는데 자꾸 접속이 안되는 문제가 있었다
    - 또 브라우저 마다 작동하는게 다 달랐다 어떤 브라우저는 접속 되는데 로그인이 안되고
    - 어떤브라우저는 아예 접속이 거부되고 등등
    - 계속 해결하려고 구글링 을 해 봤지만 다른사람들이 제안하는 방법이 잘 통하지 않았다.
    - 결국 새출발 한다는 생각으로 ec2 중단 하고 다시 시작한 다음에
    - 프론트 백 엔드 전부 다시 설치하고 천천히 해봤는데
    - 문제는 cors와 프론트 백엔드가 통신하는 주소 문제였다.
    - 도메인이 바뀌면 origin 도 전부 바뀐 도메인으로 넣어줘야 하고(프론트 백 전부)
    - 환경변수도 전부 바꿔줘야 하는데... 그걸 못해서 너무 시간을 많이 허비했다.
  - 오늘의 교훈 : ec2 는 좀 이상할 때가 많다 이럴때는 다른거 하지말고 껐다 키자.. 제발...

## 해야 할 일

- 다음 프로젝트(지렁이게임!)을 위한 준비
  - html 캔버스 사용방법 학습
  - nodejs 에서 redis 사용하는 방법 학습
  - socket.io adapter 내용 공식문서 읽으면서 학습
- 꾸준히 알고리즘 sql
  - 이번 프로젝트를 진행하면서 sql, 알고리즘 고민한 내용이 프로젝트 진행하면서 많이 도움이 되었다.
  - 꾸준히 재미있게 문제를 풀어보자!
