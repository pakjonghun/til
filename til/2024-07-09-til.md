—
date: 2024-07-09
category: til
—

## 개요

- fabric 캔버스 라이브러리 를 처음부터 다시 사용하면서 데이터 드리븐 관련 내용 정리
- mvc vs mvvm 간단한 내 생각 느낀점 정리

## 문제인식

- 현재 캔버스를 사용한 프로젝트에서 성능 이슈가 있다.
- 캔버스 내부에 fabric 객체가 포함되어 랜더링이 될때
- 이 객체는 이 객체를 그리기 위한 데이터 및 다른 노드의 데이터도 필요에 따라 구독하고 있고
- 때문에 다른 객체데이터에서 변화가 생겨도
- 모든 노드에 옵저버 콜백 함수가 실행이 되면서 불필요한 랜더링 및 js 스크립트 실행이
- 성능 저하의 원인으로 보인다.
- 물론 성능 개선을 위해 지속적으로 오랜기간 동안 노력했지만 더 이상 뚜렷한 성능 개선 효과가 없어서
- 관련해서 fabricjs 를 버전업 4.0->6.0 하여 별도 프로젝트를 작성하면서 좀더 정확한 문제 원인 파악을 하려고 한다.
- 하면서 데이터 위주의 mvvm 패턴과 mvc 패턴에 관한 생각도 차후 프로젝트에 적용해야 하므로 정리 해보려고 한다.

## 6.0 보다는 5.0

- 6.0 이 가장 최신버전이고, 각종 desperate 된 메서드가 여럿 보여서 메서드 이름을 바꿔주었는데
- 결정적으로 4.0, 5.0 에서 되던것이 6.0 에서 안되는 것을 몇가지 발견해서 결국 5.0 으로 다운 그레이드 했다.(onDrop 이벤트 및 기타 옵션 적용)
- 해당 문제는 이슈에도 올라와 있는데 아직 해결이 안된 것 같아 보였다.
- 게다가 각종 desperate 된 메서드 나 멤버가 보였는데 아쉽게도 대체 메서드가 아예 안적혀 있는 경우도 있어서, 마이그레이션시 고생을 많이 할 것 같아 보였다.

## 데이터 드리븐

- 컴포넌트에서는 단순히 데이터만 변경한다.
- 그러면 그 데이터를 구독하고 있는 fabricjs 객체가 알아서 그려지고 지워지고 업데이트 된다.
- 이 패턴 구현을 위해서 mvc 패턴보다는 조금 유연하고 코드가 적다고 알려진 mvvm 패턴이 사용되다.
- 그러나 편하고, 코드 양이 줄어든다고 해서 무조건 좋은것은 아닌것이
- 데이터가 수시로 바뀌거나 데이터가 의도치 않게 바뀌어서 다시 랜더링 되는 케이스가 있으므로
- 데이터 변경에 민감하게 반응 해야 하고, 구독을 꼭 필요한 경우에 필요한 케이스만 구독을 해줘야 한다.
- 실제로 노드를 그릴때, 노드 데이터가 있으면 노드를 그리고, 다시 노드 그렸다 라고 데이터를 변경하는데
- 웃긴거는 데이터가 바뀌었으니 또 노드를 그리는 메서드가 실행된다는 것이다.
- 그러므로 그릴 노드가 없으면 아예 그다음 실행을 막는 방식으로 처리를 해 줘야 불필요한 로직이 다시 실행되지 않는다.

## 캔버스는 단순한 저장소에서 관리

- fabric 캔버스 객체를 refObject 로 빼서 다시 랜더링이 일어나지 않게 하고 싶었다.
- 이를 위해서 무던히 노력했는데 결론은 fabric.canvas 객체는 글로벌하게 여러 뷰에서 사용해야 하므로
- 글로벌 상태로 빼서 관리 해 줄수 밖에 없다.
- refObject 는 랜더링을 줄일수 있고, 성능이 향상 될 것이라고 기대 되지만
- 실제로 꼭 필요한 캔버스 자체 랜더링이 안되는 문제가 있었다.

## mvc mvvm

- mvc 패턴은 model 과 view 를 controller가 연결해 주는 방식이다.
- 관심사를 분리하는 점에서는 좋지만
- 문제는 controller 에서 랜더링까지 신경써야 한다는 단점이 있어서
- 코드가 길어지고, 복잡해 진다는 단점이 있다.
- mvvm 도 mvc 와 비슷하지만 vm이 랜더링에 신경은 안써도 된다는 장점이 있다
- 랜더링은 view 에서 mv 를 구독하면서 자동으로 랜더링이 되도록 하면 되고
- model 은 그 자체로 존재만 하면된다
- vm 에서 모델을 갖다 쓰고, 각종 상태를 업데이트 하는 메서드를 모델에 맞는 메서드로 채워 넣으면 된다
- 그래서 mvvm 패턴을 적용하기 좋은 상태관리 라이브러리가 mobx 라고 생각된다.
- 하지만 위에서 언급한대로 데이터 변동에 민감하게 반응 해야 하므로 성능 최적화를 위해 신경을 여전히 많이 써야 한다.
